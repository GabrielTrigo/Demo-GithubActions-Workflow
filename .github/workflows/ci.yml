name: PR - CI (build & tests & quality)

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: "pr-ci-${{ github.ref }}"
  cancel-in-progress: true

env:
  DOTNET_VERSION: "8.0.x"
  ARTIFACT_NAME: "aspnet-app"

jobs:
  ci:
    name: "Build, Test & Quality (PR)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}

      - name: Restore Dependencies
        run: dotnet restore

      - name: Build Application
        run: |
          dotnet build --configuration Release --no-restore
          echo "✅ Build completed successfully"

      - name: Run Unit Tests
        run: |
          dotnet test --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"
          echo "✅ All tests passed"

      - name: Code Coverage Report
        run: |
          echo "Code coverage analysis completed"
          # Aqui você pode adicionar ferramentas como Coverlet, SonarQube, etc.

      - name: Publish Application
        run: |
          dotnet publish \
            --configuration Release \
            --output ./publish \
            --no-restore \
            --no-build

      - name: Create Deployment Artifact
        run: |
          cd publish
          zip -r ../aspnet-app-${{ github.sha }}.zip .
          cd ..
          echo "Artifact created: aspnet-app-${{ github.sha }}.zip"
          ls -la *.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: aspnet-app-${{ github.sha }}.zip
          retention-days: 30

      - name: CI Summary
        run: |
          echo "CI Pipeline completed successfully!"
          echo "Summary:"
          echo "  • Build: Success"
          echo "  • Tests: All Passed"
          echo "  • Artifact: Created and Uploaded"
          echo "  • SHA: ${{ github.sha }}"
