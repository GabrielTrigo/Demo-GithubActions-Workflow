name: CI

on:
  pull_request:
    branches:
      - dev
      - main
      - "release/*"
  push:
    branches:
      - dev
      - main
      - "release/*"
    tags:
      - "v*.*.*"

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    name: Build & Test (.NET 8)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore

      - name: Build (Release) with warnings as errors
        run: dotnet build --configuration Release /warnaserror

      - name: Test (Release)
        run: dotnet test --configuration Release --no-build --verbosity normal

      - name: Static Analysis - dotnet format check
        run: |
          dotnet tool install -g dotnet-format
          dotnet format --verify-no-changes

      - name: Vulnerabilities (packages)
        run: |
          dotnet list ./ --vulnerable || true

  # codeql:
  #   name: CodeQL Analysis
  #   runs-on: ubuntu-latest
  #   if: github.event_name != 'workflow_dispatch'
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Initialize CodeQL
  #       uses: github/codeql-action/init@v3
  #       with:
  #         languages: dotnet
  #     - name: Autobuild
  #       uses: github/codeql-action/autobuild@v3
  #     - name: Perform CodeQL Analysis
  #       uses: github/codeql-action/analyze@v3

  package:
    name: Package & Publish Artifact
    runs-on: ubuntu-latest
    needs: [build-test]
    if: github.event_name == 'push' || startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Calculate Semantic Version
        id: version
        shell: bash
        run: |
          set -e
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "v[0-9]*" 2>/dev/null || echo "v0.0.0")
          BASE=${LATEST_TAG#v}
          MAJOR=$(echo $BASE | cut -d. -f1)
          MINOR=$(echo $BASE | cut -d. -f2)
          PATCH=$(echo $BASE | cut -d. -f3)
          REF_NAME="${GITHUB_REF_NAME}"
          REF_TYPE="${GITHUB_REF_TYPE}"

          if [[ "${REF_TYPE}" == "tag" ]]; then
            SEMVER="${REF_NAME#v}"
            CHANNEL="release"
          elif [[ "${REF_NAME}" == "dev" ]]; then
            SEMVER="${MAJOR}.${MINOR}.${PATCH}-dev.${GITHUB_RUN_NUMBER}"
            CHANNEL="dev"
          elif [[ "${REF_NAME}" == "main" ]]; then
            SEMVER="${MAJOR}.${MINOR}.$((PATCH+1))"
            CHANNEL="release"
          elif [[ "${REF_NAME}" =~ ^release\/.*$ ]]; then
            SEMVER="${MAJOR}.${MINOR}.$((PATCH+1))-rc.${GITHUB_RUN_NUMBER}"
            CHANNEL="rc"
          else
            SEMVER="${MAJOR}.${MINOR}.${PATCH}-ci.${GITHUB_RUN_NUMBER}"
            CHANNEL="ci"
          fi

          echo "semver=${SEMVER}" >> $GITHUB_OUTPUT
          echo "channel=${CHANNEL}" >> $GITHUB_OUTPUT
          echo "Calculated version: ${SEMVER}"

      - name: Publish (Release)
        run: dotnet publish --configuration Release -o ./publish

      - name: Zip artifact
        run: |
          cd publish
          zip -r "../webapp-${{ steps.version.outputs.semver }}.zip" .
          cd ..

      - name: Upload artifact (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: webapp
          path: webapp-${{ steps.version.outputs.semver }}.zip
          if-no-files-found: error
          retention-days: 30

      - name: Create GitHub Release on tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: webapp-${{ steps.version.outputs.semver }}.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
