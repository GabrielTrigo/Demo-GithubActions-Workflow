name: Deploy to DEV

on:
  push:
    branches: [dev]
    paths:
      - "src/**"
      - ".github/workflows/deploy-dev.yml"
  workflow_dispatch: # Manual trigger

env:
  ARTIFACT_NAME: "app-artifact"
  ENVIRONMENT: "dev"
  APP_NAME: "MyApp"

jobs:
  deploy-dev:
    name: Deploy to DEV Environment
    runs-on: ubuntu-latest
    environment: dev # GitHub Environment com secrets

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“ Get Latest Artifact
        id: artifact
        run: |
          # Busca o artifact mais recente
          ARTIFACT=$(gh run list \
            --branch dev \
            --workflow 1-ci-build.yml \
            --status completed \
            --limit 1 \
            --json conclusion,databaseId \
            -q '.[0].databaseId')

          echo "run_id=${ARTIFACT}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: ðŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-artifact # Match do upload em CI
          path: ./deployment
        continue-on-error: true

      - name: ðŸ” Verify Artifact
        run: |
          ls -lah ./deployment/
          if [ ! -f ./deployment/${{ env.ARTIFACT_NAME }}-*.zip ]; then
            echo "âš ï¸ Artifact not found, serÃ¡ criado novo build"
            exit 1
          fi

      - name: ðŸ“‹ Log Deployment Info
        run: |
          cat > deployment_info.txt << EOF
          ========================================
          Deployment Information
          ========================================
          Environment: ${{ env.ENVIRONMENT }}
          App Name: ${{ env.APP_NAME }}
          Deployment Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Deployer: GitHub Actions
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref }}
          Repository: ${{ github.repository }}
          ========================================
          EOF
          cat deployment_info.txt

      - name: ðŸš€ Deploy to DEV (Simulated)
        run: |
          echo "=========================================="
          echo "ðŸš€ DEPLOYMENT SIMULATION: DEV"
          echo "=========================================="
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "App: ${{ env.APP_NAME }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "Deployment Steps:"
          echo "1. âœ… Download and extract artifact to D:\Apps\Dev\${{ env.APP_NAME }}"
          echo "2. âœ… Stop IIS AppPool: ${{ env.APP_NAME }}-dev"
          echo "3. âœ… Backup current version"
          echo "4. âœ… Copy new files to application folder"
          echo "5. âœ… Start IIS AppPool: ${{ env.APP_NAME }}-dev"
          echo "6. âœ… Run smoke tests"
          echo ""
          echo "Result: âœ… Deploy executado com sucesso para ${{ env.ENVIRONMENT }}"
          echo "=========================================="

      - name: âœ… Smoke Tests (Simulated)
        run: |
          echo "=========================================="
          echo "ðŸ§ª SMOKE TESTS: DEV"
          echo "=========================================="
          echo "Test 1: Health Check on http://dev.myapp.local/health"
          echo "âœ… Response: 200 OK"
          echo ""
          echo "Test 2: Database Connection"
          echo "âœ… Connected successfully"
          echo ""
          echo "Test 3: API Endpoints"
          echo "âœ… GET /api/health - OK"
          echo "âœ… POST /api/test - OK"
          echo ""
          echo "All tests passed!"
          echo "=========================================="

      - name: ðŸ“Š Create Deployment Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Deployment Summary - DEV

          ### Status: âœ… Success

          | Property | Value |
          |----------|-------|
          | Environment | ${{ env.ENVIRONMENT }} |
          | Application | ${{ env.APP_NAME }} |
          | Deployment Time | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |
          | Commit | \`${{ github.sha }}\` |
          | Branch | ${{ github.ref_name }} |
          | Run ID | ${{ github.run_id }} |

          ### Deployment Steps
          - âœ… Artifact downloaded
          - âœ… Application deployed to DEV
          - âœ… Smoke tests passed
          - âœ… Ready for next environment

          ### Next Steps
          - ðŸ”„ Promote to HOMOLOG (automatic trigger)
          - ðŸ‘€ QA to perform full testing
          EOF

      - name: ðŸ’¬ Notify Slack (Optional)
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âœ… Deploy to DEV Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âœ… Deploy to DEV - Success*\n*App:* ${{ env.APP_NAME }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: ðŸ“¤ Upload Deployment Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-dev-${{ github.run_number }}
          path: deployment_info.txt
          retention-days: 90
